<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
		.square {
			display: block;
			position: absolute;
			top: 0;
			left: 0;
			
			width: auto;
			height: auto;

			color: #FFF;
			padding: 1em;
			
			font-family: sans-serif;
			text-transform: uppercase;
			
			cursor: pointer;
		}
		
		.battleArena {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			
			margin: 0;
			padding: 0;
		}
		
		
		
    </style>
  </head>
  <body>
    
    <div class="battleArena">
    </div> 
    
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      
      var socket = io();
      var uniqid = Math.round( Math.random() * 999999 );
      
      var squares = [];
      
      var name = prompt("What is your name ?");
      var color = prompt("What is your colour ?");
      
      var createSquare = function(position, color, id, name) {
	      
	      var square = $('<div/>');
	      square.attr('id', 'id_' + id);
	      square.addClass('square');
	      square.css({
		      left: position.x,
		      top: position.y,
		      backgroundColor : color 
	      });
	      
	      square.html(name);
	      
	      return square;
      }
      
      var getRandomColor = function(){
	      return 'rgb(' + Math.round( Math.random() * 255)  + ',' + Math.round( Math.random() * 255) + ',' + Math.round( Math.random() * 255) + ')';
      }
      
      var placeSquare = function(values){
	      
	      var square = createSquare({
		      x: values.x,
		      y: values.y,
	      },  values.color, values.userId, values.name);
	         
	      $('.battleArena').append(square);
	      
	      squares.push(square);
      }
      
      socket.emit('create', JSON.stringify({
	      name:name,
	      userId:uniqid,
	      color:color,
	      x: Math.round( Math.random() * $(window).width() ),
	      y: Math.round( Math.random() * $(window).height() )
      }));
      
      $('.battleArena').click(function(evt){
	      socket.emit('position', JSON.stringify({
		      x:evt.pageX, 
		      y:evt.pageY, 
		      userId:uniqid,
		      name: name
	      }));
      });
      
      socket.on('create', function(datas){
	      var values = JSON.parse(datas);
	      placeSquare(values); 
      });
      
      socket.on('players', function(datas){
		  for(var i in datas){
			  var value = JSON.parse(datas[i]);
			  placeSquare(value);
		  }
	  });
      
      socket.on('collision', function(datas){
	      var collisions = JSON.parse(datas);
	      
	      for(var i in collisions){
		     var collision = collisions[i];
		     
		     $('#' + collision.elId).css('background-color', collision.color); 
	      }
      });

	  socket.on('delete', function(datas){
		 var player = JSON.parse(datas);
		 $('#id_' + player.userId ).remove(); 
	  });
	  
      
      socket.on('position', function(datas){
	    
	    var pos = JSON.parse(datas);
	    var userId = pos.userId;
	    	    
        $('#id_' + userId ).animate({
	        'top' : pos.y + 'px',
	        'left' : pos.x + 'px'
        }, function(){
	        
	        var me = $('#id_' + userId);
	        
	        for(var i in squares){
		        var square = squares[i];
		        
		        if(square.attr('id') == 'id_' + userId ) {
			        continue;
		        }
		        
		        var posY = parseInt(square.css('top'));
		        var posX = parseInt(square.css('left'));

		        if (pos.x < posX + square.outerWidth() &&
				   	pos.x + me.outerWidth() > posX &&
				   	pos.y < posY + square.outerHeight() &&
				   	me.outerHeight() + pos.y > posY) {
				    
				    
				    socket.emit('collision', JSON.stringify([
					    { elId:me.attr('id'), color: getRandomColor() },
					    { elId:square.attr('id'), color: getRandomColor() },
				    ]));
				    
				    
				}
		        
	        }
	        
        });
        
        
      });
      
      $(window).on('beforeunload', function(){
	      socket.emit('leave', {
		      uniqid: uniqid
	      });
      });
      
    </script>
  </body>
</html>
